{% extends 'base.jinja2' %}
{% from 'contest/contest_rule.jinja2' import contest_rule %}

{% block title %}{% block contest_title %}{% endblock %}{{ contest.title }} - {% endblock %}

{% block page_header %}{{ contest.title }}{% endblock %}

{% block content %}

  <div class="ui text menu">
    <a class="{{ active('contest:dashboard') }} {{ active('contest:problem') }} item" href="{{ url('contest:dashboard', contest.pk) }}">Dashboard</a>
    <a class="{{ active('contest:submit') }} item" href="{{ url('contest:submit', contest.pk) }}">Submit</a>
    <a class="{{ active('contest:status') }} item" href="{{ url('contest:status', contest.pk) }}">Status</a>
    {% if not contest.standings_disabled %}
      <a class="{{ active('contest:standings') }} item" href="{{ url('contest:standings', contest.pk) }}">Standings</a>
    {% endif %}
    <a class="{{ active('contest:clarification') }} item" href="{{ url('contest:clarification', contest.pk) }}">Clarification</a>
    {% if is_volunteer or is_privileged %}
      <a class="{{ active('contest:balloon') }} item" href="{{ url('contest:balloon', contest.pk) }}">Balloon</a>
    {% endif %}
  </div>

  <div class="ui grid">
    <div class="twelve wide column">
      {% block contest_content %}
      {% endblock %}
    </div>
    <div class="four wide column">
      <div class="ui segments">
      {% if contest.always_running %}
        <div class="ui segment">
          <div class="ui center aligned header">
            Always Running
          </div>
        </div>
      {% else %}
        <div class="ui segment">
          <div class="ui center aligned header">
            {% if contest.status == 0 %}
              Contest Running
            {% elif contest.status == -1 %}
              Contest Pending
            {% elif contest.pending_system_tests %}
              Pending System Tests
            {% else %}
              Contest Ended
            {% endif %}
          </div>
        </div>
        <div class="ui segment">
          <div class="ui indicating progress" data-status="{{ contest.status }}">
            <div class="bar"></div>
            {% if time_remaining %}
            <div class="countdown label" data-duration="{{ time_all }}" data-delta-seconds="{{ time_remaining }}"></div>
            {% else %}
            <div class="label">NaN</div>
            {% endif %}
          </div>
        </div>
      {% endif %}
      </div>

      {% if has_permission %}
        <div class="ui segments">
          <div class="ui segment">
            <h3 class="ui center aligned header">Problems</h3>
          </div>
          <div class="ui segment">
            <div class="ui relaxed link list">
              {% for contest_problem in contest_problem_list %}
                <a class="item {{ active('contest:problem', cid=contest.pk, pid=contest_problem.identifier) }}"
                   href="{{ url('contest:problem', contest.pk, contest_problem.identifier) }}">
                    {{ contest_problem.identifier }}. {{ contest_problem.problem.title }}
                </a>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endif %}

      <div class="ui segments">
        <div class="ui segment">
          <h3 class="ui center aligned header">Rules</h3>
        </div>
        <div class="ui segment">
          {{ contest_rule(contest) }}
        </div>
      </div>

    </div>
  </div>

{#        <div class="contest-progress">#}
{#          <h4>Contest {{ contest_status }}</h4>#}
{#          <div class="progress" style="margin-bottom: 2px">#}
{#            <div class="progress-bar bg-info countdown-progress" role="progressbar" style="width: {{ progress }}%"#}
{#                 data-status="{{ contest_status }}" data-acc="{{ progress_acc }}" data-all="{{ progress_all }}"#}
{#                 aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100"></div>#}
{#          </div>#}
{#          {% if contest_status == 'pending' %}#}
{#            <p>Before start <span class="countdown" data-delta-seconds="{{ time_delta }}">{{ time_delta | minute_filter }}</span></p>#}
{#          {% elif contest_status == 'running' %}#}
{#            <p>Before close <span class="countdown" data-delta-seconds="{{ time_delta }}">{{ time_delta | minute_filter }}</span></p>#}
{#          {% endif %}#}
{#        </div>#}

  <div class="ui basic modal" id="refreshNotification">
    <div class="ui icon header">
      <i class="announcement icon"></i>
      Announcement
    </div>
    <div class="content">
      Contest status has changed. Click to refresh the page.
    </div>
    <div class="actions">
      <div class="ui green ok inverted button" onclick="location.reload(true);">
        <i class="checkmark icon"></i>
        OK
      </div>
    </div>
  </div>

  <div class="ui basic modal" id="stayNotification">
    <div class="ui icon header">
      <i class="announcement icon"></i>
      Announcement
    </div>
    <div class="content" id="stayNotificationBody">
    </div>
    <div class="actions">
      <div class="ui green ok inverted button">
        <i class="checkmark icon"></i>
        OK
      </div>
    </div>
  </div>

{% endblock %}


{% block script %}
  <script src="/static/js/countdown.js?v=20170825"></script>
{#  <script>#}
{#    var last_update_time = "";#}
{#    function get_clarification() {#}
{#      $.ajax({#}
{#        url: "{{ url('contest:clarification_update', contest.pk) }}",#}
{#        data: { 'time': last_update_time },#}
{#        type: "GET",#}
{#        complete: function(data, status) {#}
{#          new_data = JSON.parse(data.responseText);#}
{#          last_update_time = new_data['time'];#}
{#          if (new_data['response'] != 'reject') {#}
{#            if (new_data['response']) {#}
{#              $("#stayNotificationBody").html(new_data['type'] + new_data['response']);#}
{#              $("#stayNotification").modal('show');#}
{#              $("#clarification-badge").show();#}
{#            }#}
{#            setTimeout(function () {#}
{#              get_clarification();#}
{#            }, 30000);#}
{#          }#}
{#        }#}
{#      });#}
{#    }#}
{#    get_clarification();#}
{##}
{#  </script>#}
  {% block local_script %}{% endblock %}
{% endblock %}